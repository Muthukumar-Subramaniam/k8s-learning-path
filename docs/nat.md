# ğŸ”€ NAT (Network Address Translation)

## ğŸ“‹ Table of Contents
1. [What is NAT?](#what-is-nat)
2. [Types of NAT](#types-of-nat)
3. [How NAT Works](#how-nat-works)
4. [NAT in Kubernetes](#nat-in-kubernetes)
5. [Connection Tracking](#connection-tracking)
6. [Troubleshooting](#troubleshooting)

---

## ğŸ” What is NAT?

**NAT (Network Address Translation)** is a method of remapping IP addresses by modifying network address information in the IP header of packets while they are in transit across a routing device.

### Purpose of NAT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Why NAT Exists                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Original Problem:                                           â”‚
â”‚  â€¢ IPv4 address exhaustion (only 4.3 billion addresses)      â”‚
â”‚  â€¢ Private networks need internet access                     â”‚
â”‚  â€¢ Security/isolation requirements                           â”‚
â”‚                                                              â”‚
â”‚  Solutions NAT Provides:                                     â”‚
â”‚                                                              â”‚
â”‚  âœ… Address Conservation                                     â”‚
â”‚     â€¢ Many private IPs â†’ One public IP                       â”‚
â”‚     â€¢ Conserves public IPv4 addresses                        â”‚
â”‚                                                              â”‚
â”‚  âœ… Security                                                 â”‚
â”‚     â€¢ Hides internal network structure                       â”‚
â”‚     â€¢ Acts as basic firewall                                 â”‚
â”‚     â€¢ Makes internal IPs unreachable from internet           â”‚
â”‚                                                              â”‚
â”‚  âœ… Flexibility                                              â”‚
â”‚     â€¢ Change internal IPs without affecting external         â”‚
â”‚     â€¢ Multiple private networks can use same IP ranges       â”‚
â”‚     â€¢ Network renumbering made easier                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NAT Terminology

| Term | Description | Example |
|------|-------------|---------|
| **Inside Local** | Source IP before NAT | 192.168.1.10 (Pod) |
| **Inside Global** | Source IP after NAT | 203.0.113.50 (Node) |
| **Outside Global** | Destination IP | 8.8.8.8 (Google DNS) |
| **Outside Local** | Destination IP (if NATted) | Same as global |

---

## ğŸ”§ Types of NAT

### 1. SNAT (Source NAT)

Changes the **source** IP address of outgoing packets.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SNAT Operation                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Use Case: Pod accessing the internet                        â”‚
â”‚                                                              â”‚
â”‚  Before NAT (Outgoing):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      10.244.1.5 (Pod)                     â”‚ â”‚
â”‚  â”‚  Source Port:    54321                                 â”‚ â”‚
â”‚  â”‚  Dest IP:        8.8.8.8 (Google DNS)                  â”‚ â”‚
â”‚  â”‚  Dest Port:      53                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ SNAT                                 â”‚
â”‚                       â”‚                                      â”‚
â”‚  After NAT (Outgoing):                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      192.168.1.10 (Node) â—„â”€â”€ Changed       â”‚ â”‚
â”‚  â”‚  Source Port:    42187 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Changed     â”‚ â”‚
â”‚  â”‚  Dest IP:        8.8.8.8                               â”‚ â”‚
â”‚  â”‚  Dest Port:      53                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚                   Internet                                   â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚  Return Traffic (Incoming):                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      8.8.8.8                               â”‚ â”‚
â”‚  â”‚  Source Port:    53                                    â”‚ â”‚
â”‚  â”‚  Dest IP:        192.168.1.10 (Node)                   â”‚ â”‚
â”‚  â”‚  Dest Port:      42187                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ Reverse NAT                          â”‚
â”‚                       â”‚                                      â”‚
â”‚  After Reverse NAT:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      8.8.8.8                               â”‚ â”‚
â”‚  â”‚  Source Port:    53                                    â”‚ â”‚
â”‚  â”‚  Dest IP:        10.244.1.5 (Pod) â—„â”€â”€ Restored         â”‚ â”‚
â”‚  â”‚  Dest Port:      54321 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Restored       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**iptables SNAT rule**:
```bash
# Basic SNAT
iptables -t nat -A POSTROUTING -s 10.244.0.0/16 \
  -o eth0 -j SNAT --to-source 192.168.1.10

# MASQUERADE (dynamic SNAT for DHCP interfaces)
iptables -t nat -A POSTROUTING -s 10.244.0.0/16 \
  -o eth0 -j MASQUERADE
```

### 2. DNAT (Destination NAT)

Changes the **destination** IP address of incoming packets.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DNAT Operation                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Use Case: External traffic to Kubernetes Service            â”‚
â”‚                                                              â”‚
â”‚  Before NAT (Incoming):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      203.0.113.100 (Client)                â”‚ â”‚
â”‚  â”‚  Source Port:    38291                                 â”‚ â”‚
â”‚  â”‚  Dest IP:        192.168.1.10:30080 (NodePort)         â”‚ â”‚
â”‚  â”‚  Dest Port:      30080                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ DNAT                                 â”‚
â”‚                       â”‚                                      â”‚
â”‚  After NAT (Forwarded):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Source IP:      203.0.113.100                         â”‚ â”‚
â”‚  â”‚  Source Port:    38291                                 â”‚ â”‚
â”‚  â”‚  Dest IP:        10.244.1.5 (Pod) â—„â”€â”€ Changed          â”‚ â”‚
â”‚  â”‚  Dest Port:      8080 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Changed       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚                   Pod receives                               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**iptables DNAT rule**:
```bash
# Port forwarding (DNAT)
iptables -t nat -A PREROUTING -p tcp \
  --dport 30080 -j DNAT --to-destination 10.244.1.5:8080

# Load balancing DNAT (multiple destinations)
iptables -t nat -A PREROUTING -p tcp --dport 80 \
  -m statistic --mode random --probability 0.5 \
  -j DNAT --to-destination 10.244.1.5:8080

iptables -t nat -A PREROUTING -p tcp --dport 80 \
  -j DNAT --to-destination 10.244.2.8:8080
```

### 3. Masquerading

Special form of SNAT for dynamic IP addresses (e.g., DHCP).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Masquerading vs SNAT                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  SNAT:                                                       â”‚
â”‚  â€¢ Requires static source IP                                 â”‚
â”‚  â€¢ Slightly better performance                               â”‚
â”‚  â€¢ Example: --to-source 192.168.1.10                         â”‚
â”‚                                                              â”‚
â”‚  MASQUERADE:                                                 â”‚
â”‚  â€¢ Works with dynamic IPs (DHCP, PPPoE)                      â”‚
â”‚  â€¢ Automatically uses outgoing interface IP                  â”‚
â”‚  â€¢ Slightly higher overhead (IP lookup)                      â”‚
â”‚  â€¢ Example: -j MASQUERADE                                    â”‚
â”‚                                                              â”‚
â”‚  Kubernetes typically uses MASQUERADE because:               â”‚
â”‚  â€¢ Node IPs might be dynamic (cloud)                         â”‚
â”‚  â€¢ Works across different network configs                    â”‚
â”‚  â€¢ Simpler rule management                                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Full NAT (SNAT + DNAT)

Both source and destination addresses are translated.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Full NAT                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Original Packet:                                            â”‚
â”‚  Source: 10.244.1.5:54321 â†’ Dest: 10.96.100.1:80            â”‚
â”‚                                                              â”‚
â”‚  After DNAT (Service â†’ Pod):                                 â”‚
â”‚  Source: 10.244.1.5:54321 â†’ Dest: 10.244.2.8:8080           â”‚
â”‚                                                              â”‚
â”‚  After SNAT (for return path):                               â”‚
â”‚  Source: 10.244.1.5:54321 â†’ Dest: 10.244.2.8:8080           â”‚
â”‚                                                              â”‚
â”‚  Return path works because both translations tracked         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ How NAT Works

### Connection Tracking (conntrack)

NAT relies on **connection tracking** to remember translations:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Connection Tracking System                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Conntrack Table (in kernel memory):                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Protocol  Original              Reply                 â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  tcp       10.244.1.5:54321 â†’    8.8.8.8:53 â†’         â”‚ â”‚
â”‚  â”‚            8.8.8.8:53            192.168.1.10:42187    â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  tcp       203.0.113.100:38291 â†’ 10.244.1.5:8080 â†’    â”‚ â”‚
â”‚  â”‚            192.168.1.10:30080    203.0.113.100:38291  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  State: NEW, ESTABLISHED, RELATED, INVALID             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  For each connection, tracks:                                â”‚
â”‚  â€¢ Original source/dest IP and port                          â”‚
â”‚  â€¢ Translated source/dest IP and port                        â”‚
â”‚  â€¢ Protocol (TCP, UDP, ICMP)                                 â”‚
â”‚  â€¢ Connection state                                          â”‚
â”‚  â€¢ Timeout values                                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NAT Translation Table

```bash
# View connection tracking table
conntrack -L

# Example output:
tcp  6 431999 ESTABLISHED src=10.244.1.5 dst=8.8.8.8 \
     sport=54321 dport=53 \
     src=8.8.8.8 dst=192.168.1.10 sport=53 dport=42187 \
     [ASSURED] mark=0 use=1

# Count connections
conntrack -L | wc -l

# Show connection statistics
conntrack -S

# Delete specific connection
conntrack -D -p tcp --orig-port-src 54321
```

### NAT Packet Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NAT in Netfilter Pipeline                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚                 Incoming Packet                              â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â”‚  PREROUTING    â”‚                              â”‚
â”‚              â”‚  â€¢ DNAT        â”‚ â—„â”€â”€ Destination NAT          â”‚
â”‚              â”‚  â€¢ Port fwd    â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                       â”‚                                      â”‚
â”‚                  Routing                                     â”‚
â”‚                  Decision                                    â”‚
â”‚                       â”‚                                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚            â”‚                     â”‚                           â”‚
â”‚       For local?             Forward?                        â”‚
â”‚            â”‚                     â”‚                           â”‚
â”‚            â–¼                     â–¼                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚   INPUT      â”‚      â”‚   FORWARD    â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                     â”‚                            â”‚
â”‚           â–¼                     â–¼                            â”‚
â”‚    Local Process         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚              â”‚ POSTROUTING  â”‚                   â”‚
â”‚           â”‚              â”‚ â€¢ SNAT       â”‚ â—„â”€â”€ Source NAT     â”‚
â”‚           â–¼              â”‚ â€¢ MASQUERADE â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â”‚   OUTPUT     â”‚             â”‚                           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                           â”‚
â”‚           â”‚                     â”‚                            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚                                        â”‚
â”‚                     â–¼                                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚ POSTROUTING  â”‚                                â”‚
â”‚              â”‚ â€¢ SNAT       â”‚                                â”‚
â”‚              â”‚ â€¢ MASQUERADE â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                     â”‚                                        â”‚
â”‚                     â–¼                                        â”‚
â”‚              Outgoing Packet                                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

See [linux-networking.md](linux-networking.md) for detailed netfilter explanation.

---

## ğŸ NAT in Kubernetes

Kubernetes uses NAT extensively for various networking scenarios:

### 1. Pod to External (SNAT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Pod to Internet Traffic (SNAT)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Pod (10.244.1.5) â†’ Internet (8.8.8.8)                       â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Pod   â”‚       â”‚    Node     â”‚       â”‚ Internet â”‚      â”‚
â”‚  â”‚10.244.1.5â”‚ â”€â”€â”€â”€â–º â”‚192.168.1.10 â”‚ â”€â”€â”€â”€â–º â”‚ 8.8.8.8  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚                    SNAT/MASQUERADE                           â”‚
â”‚                    (iptables)                                â”‚
â”‚                                                              â”‚
â”‚  iptables rule (automatic by CNI):                           â”‚
â”‚  -A POSTROUTING -s 10.244.0.0/16 ! -d 10.244.0.0/16 \       â”‚
â”‚    -j MASQUERADE                                             â”‚
â”‚                                                              â”‚
â”‚  Why needed:                                                 â”‚
â”‚  â€¢ Pod IPs (10.244.x.x) not routable on internet            â”‚
â”‚  â€¢ Must use Node IP for return traffic                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Configuration** (Calico example):
```yaml
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: default-ipv4-ippool
spec:
  cidr: 10.244.0.0/16
  natOutgoing: true  # Enable SNAT for external traffic
```

### 2. NodePort Service (DNAT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NodePort Service (DNAT + SNAT)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  External Client â†’ Node:30080 â†’ Pod:8080                     â”‚
â”‚                                                              â”‚
â”‚  1. Client Request                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Src: 203.0.113.100:38291                               â”‚ â”‚
â”‚  â”‚ Dst: 192.168.1.10:30080 (NodePort)                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ DNAT (by kube-proxy)                 â”‚
â”‚                       â”‚                                      â”‚
â”‚  2. After DNAT                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Src: 203.0.113.100:38291                               â”‚ â”‚
â”‚  â”‚ Dst: 10.244.1.5:8080 (Pod)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ SNAT (for return path)               â”‚
â”‚                       â”‚                                      â”‚
â”‚  3. After SNAT                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Src: 192.168.1.10:42187 (Node)                         â”‚ â”‚
â”‚  â”‚ Dst: 10.244.1.5:8080 (Pod)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  Return traffic automatically reversed by conntrack          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**iptables rules** (created by kube-proxy):
```bash
# DNAT to ClusterIP
-A KUBE-SERVICES -p tcp --dport 30080 \
  -j KUBE-SVC-NGINX

# DNAT to Pod
-A KUBE-SEP-ABC123 -p tcp \
  -j DNAT --to-destination 10.244.1.5:8080

# SNAT for return traffic
-A KUBE-POSTROUTING -j MASQUERADE
```

### 3. ClusterIP Service (DNAT only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ClusterIP Service (DNAT only)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Pod A â†’ ClusterIP â†’ Pod B                                   â”‚
â”‚                                                              â”‚
â”‚  1. Pod A Request                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Src: 10.244.1.5:54321                                  â”‚ â”‚
â”‚  â”‚ Dst: 10.96.100.1:80 (ClusterIP)                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â–¼ DNAT (by kube-proxy)                 â”‚
â”‚                       â”‚                                      â”‚
â”‚  2. After DNAT                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Src: 10.244.1.5:54321 (unchanged)                      â”‚ â”‚
â”‚  â”‚ Dst: 10.244.2.8:8080 (Pod B)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  No SNAT needed (both IPs in pod network)                    â”‚
â”‚  Return traffic goes directly back                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Hairpin NAT

Special case: Pod accessing its own service via ClusterIP:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Hairpin NAT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Problem: Pod A accesses Service, selected backend is Pod A  â”‚
â”‚                                                              â”‚
â”‚  Without Hairpin:                                            â”‚
â”‚  Pod A â†’ ClusterIP â†’ (DNAT) â†’ Pod A                          â”‚
â”‚  Return traffic doesn't match connection (drops)             â”‚
â”‚                                                              â”‚
â”‚  With Hairpin (SNAT):                                        â”‚
â”‚  1. Src: 10.244.1.5 â†’ Dst: 10.96.100.1 (ClusterIP)          â”‚
â”‚  2. DNAT: Dst becomes 10.244.1.5 (same pod!)                 â”‚
â”‚  3. SNAT: Src becomes node IP (hairpin)                      â”‚
â”‚  4. Traffic goes Pod A â†’ Node â†’ Pod A                        â”‚
â”‚  5. Return traffic matches connection                        â”‚
â”‚                                                              â”‚
â”‚  iptables rule:                                              â”‚
â”‚  -A KUBE-POSTROUTING -s 10.244.0.0/16 -d 10.244.0.0/16 \    â”‚
â”‚    -j MASQUERADE                                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NAT-Free Kubernetes Networking

Some CNIs avoid NAT for better performance:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                NAT vs NAT-Free Networking                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  With NAT (Most CNIs):                                       â”‚
â”‚  âœ… Works everywhere                                         â”‚
â”‚  âœ… Simple setup                                             â”‚
â”‚  âŒ Connection tracking overhead                             â”‚
â”‚  âŒ Debugging harder (IPs change)                            â”‚
â”‚  âŒ Performance impact (SNAT/DNAT)                           â”‚
â”‚                                                              â”‚
â”‚  NAT-Free (Calico BGP mode):                                 â”‚
â”‚  âœ… Better performance (no NAT overhead)                     â”‚
â”‚  âœ… Direct routing                                           â”‚
â”‚  âœ… Easier debugging (real IPs visible)                      â”‚
â”‚  âŒ Requires BGP support                                     â”‚
â”‚  âŒ More complex network setup                               â”‚
â”‚                                                              â”‚
â”‚  Best of Both:                                               â”‚
â”‚  â€¢ NAT-free inside cluster (pod-to-pod)                      â”‚
â”‚  â€¢ NAT for external traffic (pod-to-internet)                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

See [bgp.md](bgp.md) for NAT-free routing with BGP.

---

## ğŸ” Connection Tracking

### Connection States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Connection Tracking States                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  NEW:                                                        â”‚
â”‚  â€¢ First packet of new connection                            â”‚
â”‚  â€¢ No prior packets seen                                     â”‚
â”‚                                                              â”‚
â”‚  ESTABLISHED:                                                â”‚
â”‚  â€¢ Connection with packets in both directions                â”‚
â”‚  â€¢ Bidirectional communication confirmed                     â”‚
â”‚                                                              â”‚
â”‚  RELATED:                                                    â”‚
â”‚  â€¢ New connection related to existing one                    â”‚
â”‚  â€¢ Example: FTP data connection from control connection      â”‚
â”‚                                                              â”‚
â”‚  INVALID:                                                    â”‚
â”‚  â€¢ Packet doesn't match known connection                     â”‚
â”‚  â€¢ Usually dropped                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Conntrack Commands

```bash
# View all connections
conntrack -L

# Count connections
conntrack -L | wc -l

# Show statistics
conntrack -S

# Filter by protocol
conntrack -L -p tcp
conntrack -L -p udp

# Filter by IP
conntrack -L -s 10.244.1.5
conntrack -L -d 8.8.8.8

# Delete connections (for debugging)
conntrack -D -p tcp --orig-port-src 54321

# Watch connections in real-time
watch -n 1 'conntrack -L | wc -l'

# Conntrack limits
sysctl net.netfilter.nf_conntrack_max
sysctl net.netfilter.nf_conntrack_count

# Increase limit (if needed)
sysctl -w net.netfilter.nf_conntrack_max=262144
```

### Conntrack Tuning

```bash
# View current settings
sysctl -a | grep conntrack

# Important settings for Kubernetes
# Maximum tracked connections
net.netfilter.nf_conntrack_max = 262144

# TCP timeout for established connections (default 5 days)
net.netfilter.nf_conntrack_tcp_timeout_established = 86400

# Timeout for connections in TIME_WAIT
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120

# Conntrack table size (hash table)
net.netfilter.nf_conntrack_buckets = 65536
```

---

## ğŸ› ï¸ Troubleshooting

### Debugging NAT Issues

```bash
# 1. Check NAT rules
iptables -t nat -L -n -v

# 2. Check connection tracking
conntrack -L | grep <ip-address>

# 3. Enable packet tracing
iptables -t raw -A PREROUTING -p tcp --dport 80 -j TRACE
iptables -t raw -A OUTPUT -p tcp --dport 80 -j TRACE

# View trace logs
tail -f /var/log/kern.log | grep TRACE

# 4. Check for conntrack table full
dmesg | grep "nf_conntrack: table full"

# 5. Test connectivity
# From pod
kubectl exec -it <pod> -- curl <service-ip>

# Check if SNAT is working
tcpdump -i eth0 -nn host <external-ip>
```

### Common NAT Problems

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Common NAT Issues                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Conntrack Table Full                                     â”‚
â”‚     Symptom: Connections fail randomly                       â”‚
â”‚     Fix: Increase nf_conntrack_max                           â”‚
â”‚     Check: dmesg | grep "table full"                         â”‚
â”‚                                                              â”‚
â”‚  2. Asymmetric Routing                                       â”‚
â”‚     Symptom: One-way traffic works                           â”‚
â”‚     Cause: Return path different from forward                â”‚
â”‚     Fix: Ensure symmetric routing or disable rp_filter       â”‚
â”‚                                                              â”‚
â”‚  3. Hairpin Not Working                                      â”‚
â”‚     Symptom: Pod can't reach its own service                 â”‚
â”‚     Fix: Enable hairpin mode on bridge/CNI                   â”‚
â”‚     Check: ip link show <bridge> | grep hairpin              â”‚
â”‚                                                              â”‚
â”‚  4. SNAT Not Applied                                         â”‚
â”‚     Symptom: External services see pod IP                    â”‚
â”‚     Fix: Check natOutgoing setting in CNI                    â”‚
â”‚     Check: iptables -t nat -L POSTROUTING                    â”‚
â”‚                                                              â”‚
â”‚  5. Port Exhaustion                                          â”‚
â”‚     Symptom: New connections fail                            â”‚
â”‚     Cause: Too many NAT mappings from single IP              â”‚
â”‚     Fix: Use multiple node IPs or adjust port range          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NAT Performance Monitoring

```bash
# Connection tracking statistics
conntrack -S

# NAT table packet counts
iptables -t nat -L -n -v -x

# Per-rule statistics
iptables -t nat -L KUBE-SERVICES -n -v

# System load from conntrack
top -p $(pgrep -d',' conntrack)

# Check dropped packets due to invalid state
iptables -L -v | grep INVALID
```

---

## ğŸ“š Additional Resources

- [NAT - Wikipedia](https://en.wikipedia.org/wiki/Network_address_translation)
- [Linux iptables NAT](https://www.netfilter.org/documentation/HOWTO/NAT-HOWTO.html)
- [Connection Tracking](https://www.netfilter.org/documentation/HOWTO/netfilter-hacking-HOWTO-3.html)
- [kube-proxy Documentation](kube-proxy.md)

---

## ğŸ”— Related Topics

- [Linux Networking (iptables/IPVS)](linux-networking.md)
- [kube-proxy](kube-proxy.md)
- [BGP (NAT-free routing)](bgp.md)
- [Kubernetes Networking Fundamentals](k8s-networking-fundamentals.md)
